replicaCount: 1

image:
  repository: dievri/inferno-os
  pullPolicy: Always
  tag: "focal"

serviceAccount:
  create: false

securityContext: {}

externalPort: &externalPort 30098
internalPort: &internalPort 6678

service:
  - type: ClusterIP
    port: *internalPort

nodePortRange:
  from: *externalPort
  to: 30099
  proto: tcp

storage:
  size: 4Gi
#  class: yc-network-ssd
  mountPath: /usr/inferno-os/host/storage


ingress:
  enabled: false

resources: {}
autoscaling:
  enabled: false

env:
  - name: INTERNAL_PORT
    value: *internalPort
  - name: EXTERNAL_PORT
    value: *externalPort

files: 
  namespace_9mine_9front:
    path: /usr/inferno-os/host/storage/9mine/files/9front/9mine.ns
    data: |
      bind  /root /root
      mount -aC '#s/boot' /root
      bind  / /
      bind -a /root /
      mount -a '#s/boot' /
      bind -c #s /srv
      bind  '#c' /dev
      bind  '#d' /fd
      bind -c '#e' /env
      bind  '#p' /proc
      bind  '#σ' /shr
      bind -a '#¤' /dev
      bind -a '#¶' /dev
      bind  /mnt /mnt
      mount -b '#s/factotum' /mnt
      bind  /n /n
      mount -a '#s/slashn' /n
      mount -a '#s/slashmnt' /mnt
      bind  /mnt/exportfs /mnt/exportfs
      mount -a '#s/mntexport' /mnt/exportfs
      bind  /amd64/bin /bin
      bind -a /rc/bin /bin
      bind  /net /net
      bind -a '#l' /net
      bind -a '#I' /net
      mount -a '#s/cs' /net
      mount -a '#s/dns' /net

#      mount -a tcp!files.dev.metacoma.io!30098 /n/gridfiles
#      mount -a tcp!registry.dev.metacoma.io!30100 /mnt/registry
#      mount -a tcp!root.9gridchan.org!564 /n/gridfs/
#      cd /usr/$user
      
  newns_9front:
    path: /usr/inferno-os/host/storage/9mine/files/9front/newuser.rc
    data: |
      #!/bin/rc
      NAME=$1
      SESSION=cmdchan-$NAME
      
      CMDCHAN_ROOT = /tmp/file2chan/
      CMDCHAN_IN = $CMDCHAN_ROOT/cmd
      
      
      cd /usr/glenda/mq
      ./mq -s $SESSION
      mount -c /srv/$SESSION /n/$SESSION
      
      mkdir -p $CMDCHAN_ROOT /n/$SESSION/rc
      touch /n/$SESSION/rc/fd0 $CMDCHAN_IN
      
      rc -i < /n/$SESSION/rc/fd0 &
      
      bind /n/$SESSION/rc/fd0 $CMDCHAN_IN
      
      MIN_PORT=40000
      MAX_PORT=50000
      
      PORT=`{netstat -n | awk -v 'MIN_PORT='$MIN_PORT -v 'MAX_PORT='$MAX_PORT '/Listen/ && ($5 > MIN_PORT && $5 < MAX_PORT) { print $5 }' | sort -rn | awk -v 'MIN_PORT='$MIN_PORT 'BEGIN { port = MIN_PORT} { port = $0 + 1; exit } END { print port }'}
      
      rm /srv/registry.dev.metacoma.io!30100 /srv/tcp!root.9gridchan.org!564
      9fs tcp!registry.dev.metacoma.io!30100 /mnt/registry
      9fs tcp!root.9gridchan.org!564 /n/gridfs/
      /n/gridfs/amd64/bin/gridlisten1 -tv 'tcp!*!'$PORT exportfs -r / &
    
  profile:  
    path: /usr/inferno-os/lib/sh/profile
    data: |
      load file2chan
      load std
      ndb/cs
      for host_var in `{ os env } { '{'$host_var'}' }
  
      os mkdir -p /usr/inferno-os/host/storage
      os chmod -R a+rwx /usr/inferno-os/host
      test -d /storage || mkdir /storage

      bind -ac '#U/host/storage' /storage
      chmod a+rwx /storage

      for d in welcomefs registry/logo files {  
        d = '/storage/9mine/'^$d
        test -d $d || mkdir -p $d 
        chmod a+rwx $d
      }



      test -d /mnt/registry || mkdir -p /mnt/registry
      mount -A tcp!registry.dev.metacoma.io!30100 /mnt/registry

      port = $INTERNAL_PORT
      external_port = $EXTERNAL_PORT
      echo 'Internal registry port '^$port
      echo 'External registry port '^$external_port

      echo 'files.dev.metacoma.io' > /dev/sysname
      grid/reglisten -A -r type files 'tcp!*!'^$external_port { export /storage & }
